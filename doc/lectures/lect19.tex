\section{Лекция 19 (13.04)}

\subsection{СBS схема решения уравнений Навье-Стокса}
CBS (Characteristic Stabilized Split)
метод основан на конечнообъемной аппроксимации определяющих уравнений.
При решении уравнения используется стабилизация методом характеристик.
Вследствии стабилизации метод позволяет использовать одинаковую конечноэлелментную
аппароксимацию для давления и компонент скорости.

\subsubsection{Постановка задачи для слабосжимаемой жидкости}
Рассмотрим определяющую безразмерную систему уравнений, описывающую
течение слабосжимаемой жидкости:
\begin{align}
\label{eq:cbs_u}
&\dfr{U}{t} + \vec u\cdot\nabla U = -\dfr{p}{x} + \frac{1}{\Ren}\nabla^2 u \\[10pt]
\label{eq:cbs_v}
&\dfr{V}{t} + \vec u\cdot\nabla V = -\dfr{p}{y} + \frac{1}{\Ren}\nabla^2 v \\[10pt]
\label{eq:cbs_rho}
&\dfr{\rho}{t} + \nabla\cdot\vec U = 0 \\[10pt]
\label{eq:cbs_rho_p}
&\dfr{\rho}{t} = \frac{1}{c^2}\dfr{p}{t}.
\end{align}
Здесь введены следующие обозначения:
$\rho$ -- плотность жидкости,
$U = \rho u$, $V = \rho v$ -- компоненты импульса течения,
$c$ -- скорость распространения возмущений (скорость звука).

\subsubsection{Конечноэлементная аппроксимация}
Для дискретизации по времени будем использовать явную по скорости и $\theta$ по давлению двухслойную схему.
При записи слабой постановки для соотношений \cref{eq:cbs_u,eq:cbs_v}
используем стабилизацию методом характеристик (см. п.~\ref{sec:char-stap}).
Тогда получим
\begin{equation}
\nonumber
\begin{split}
\feint{\frac{\hat U - U}{\tau}\phi_i} =
&- \feint{\vec u \cdot \nabla U \phi_i}
 +\frac{\tau}{2}\feint{\left(\vec u \cdot \nabla U \right)\left(\vec u \cdot \nabla \phi_i\right)}
\\
&
 \left(
 -\feint{\dfr{p}{x}\phi_i}
 +\frac{\tau}{2}\feint{\dfr{p}{x}\vec u \cdot \nabla\phi_i}
 \right)^{\theta_2}
\\
&
 -\frac{1}{\Ren}\feint{\nabla u \cdot \nabla \phi_i}
 +\frac{1}{\Ren}\febint{\dfr{u}{n}\phi_i}
 +\frac{\tau}{2\Ren}\feint{\nabla u \cdot \nabla (\vec u \cdot \nabla \phi_i)}
\end{split}
\end{equation}
Здесь используется следующая запись для $\theta$-схемы
$$
\left( F\right)^{\theta} = \theta \hat F + (1 - \theta) F.
$$
В правой части полученного соотнешнии все слагаемые с
множителем $\sfrac{\tau}{2}$ получены в результате стабилизации.
При этом последний из них, как отмечалось ранее,
тождественен нулю при использовании линейных лагранжевых
конечных элементов. Поэтому его в дальншейшем будем опускать.

Разобъём полученное соотношение на два: первое из которых не содержит давления:
\begin{align}
\label{eq:cbs_split1}
\begin{split}
\frac{1}{\tau}\feint{\delta U^*\phi_i} =
&- \feint{\vec u \cdot \nabla U \phi_i}
 +\frac{\tau}{2}\feint{\left(\vec u \cdot \nabla U \right)\left(\vec u \cdot \nabla \phi_i\right)}
\\
&
 -\frac{1}{\Ren}\feint{\nabla u \cdot \nabla \phi_i}
 +\frac{1}{\Ren}\febint{\dfr{u}{n}\phi_i},
\end{split}\\
\label{eq:cbs_split2}
\begin{split}
\frac1\tau\feint{\delta U^{**}\phi_i} =
&
 \left(
 -\feint{\dfr{p}{x}\phi_i}
 +\frac{\tau}{2}\feint{\dfr{p}{x}\vec u \cdot \nabla\phi_i}
 \right)^{\theta_2}
\end{split}
\end{align}
где введены две поправки импульса:
\begin{align*}
\delta U^* = \tilde U - U, \\
\delta U^{**} = \hat U - \tilde U
\end{align*}
так, что $\hat U = U + \delta U^* + \delta U^{**}$.

Соотношение \cref{eq:cbs_rho,eq:cbs_rho_p}
так же распишем по двухслойной $\theta$ схеме:
\begin{equation}
\label{eq:cbs_split3}
\begin{split}
\frac1{c^2\tau}\feint{(\hat p - p)\phi_i}
&
= -\left(\feint{\nabla\cdot \vec U \phi_i}\right)^{\theta_1}
\\
&
=-\feint{\nabla\cdot \vec U \phi_i}
 -\theta_1 \feint{\nabla\cdot \vec {\delta U}^* \phi_i}
 -\theta_1 \feint{\nabla\cdot \vec {\delta U}^{**} \phi_i}
\end{split}
\end{equation}

\subsubsection{Порядок расчёта на временном слое}
Для замены последнего слагаемого в правой части \cref{eq:cbs_split3}
воспользуемся соотношением \cref{eq:cbs_slit2} (и аналогичным соотнешением для $V^{*}$ компоненты импульса),
отбрасывая слагаемые при $\tau^2$.
Используя интегрирование по частям получим уравнение для давления
\begin{equation}
\label{eq:cbs_preseq}
\begin{split}
\frac1{c^2\tau}\feint{(\hat p - p)\phi_i}
 +\theta_1 \theta_2 \tau \feint{\nabla \hat p \cdot \nabla \phi_i}
=
&
-\feint{\nabla\cdot \vec U \phi_i}
\\
&
 +\theta_1 \feint{\vec {\delta U}^* \cdot \nabla \phi_i}
\\
&
 -\theta_1 (1 - \theta_2)\tau\feint{\nabla p \cdot \nabla \phi_i}.
\end{split}
\end{equation}
Здесь при выводе использовались граничные соотношения $\dsfr{p}{n} = 0$ и $\vec {\delta U}^* \cdot \vec n = 0$.
Тогда порядок расчёта на временном слое примет вид:
\begin{enumerate}
\item
Определяем первую поправку импульса $\vec{\delta U}^*$ из уравнения \cref{eq:cbs_split1};
\item
Определяем давления $\hat p$ из соотношения \cref{eq:cbs_preseq};
\item
Определяем вторую поправку импульса $\vec{\delta U}^{**}$ из уравнения \cref{eq:cbs_split2}.
\item
Вычисляем $\vec{\hat U}$. Удовлетворяем граничные условия по скорости. В случае слабосжимаемой жидкости $c >> 1$ значение плотности
будет $\rho \approx 1$, поэтому можно положить $\vec {\hat u} = \vec {\hat U}$.
\end{enumerate}

\subsubsection{Полунеявная схема}
\label{seq:cbs_semiimp}
Уравнения с \cref{eq:cbs_split1,eq:cbs_split2} с
первого и третьего шагов алгоритма могут быть решены явно
в случае, если их матрицы левой части будет диагональной.
Этого можно добиться если использовать
линейные конечные элементы и провести процедуру \quo{концентрации масс},
в результате которой матрица масс примет диагональный вид
$$
m_i = \sum_{j=0}^{N}\feint{\phi_j \phi_i}.
$$
Тогда единственным источником неявности
остаётся параметр $\theta_2$ из уравнения \cref{eq:cbs_split3}.
Будем считать схему полунеявной, если $\theta_2 \in [\sfrac12, 1]$.
В этом случае на каждом слое будет необходимо решить одну СЛАУ на втором шаге алгоритма.

Условие устойчивости для неявной схемы запишем как
\begin{equation}
\label{eq:cbs_semiimp_stabcond}
\tau < \min\left(\frac{h}{|\vec u|}, \frac{h^2 \Ren}{2}\right)
\end{equation}
Здесь $h$ -- характерый линейный размер элемента.

\subsubsection{Явная схема}
\label{seq:cbs_exp}
Явной будем называть схему, у которой $\theta_2 = 0$.
Условием устойчивости для явной схемы сформулируем в виде
\begin{equation}
\label{eq:cbs_exp_stabcond}
\tau < \frac{h}{|\vec u| + c}
\end{equation}

\subsubsection{Стационарное течение}
В случае, если рассматривается
стационарное течение, то постановка \cref{eq:cbs_u,eq:cbs_v,eq:cbs_rho,eq:cbs_rho_p}
используюется для получения решения методом установления.
То есть решение продолжается до тех пор, пока
искомые функции $\vec U, p$ не перестанут меняться.
Параметр $\tau$ становится шагом по фиктивному времени, т.е. простым итерационным параметром,
не имеющим специального физического смысла. Это снимает многие ограничения на его выбор.
В частности, можно вместо постоянного шага вычислять собсвенный $\tau$
для каждого узла сетки (т.е. для каждой строки системы линейных уравнений).
В этом случае в формулах \cref{eq:cbs_split1,eq:cbs_split2,eq:cbs_preseq}
и подобных вместо $\tau$ будут присутствовать $\tau_i$,
которые в свою очередь будут находится локально.
Например из \cref{eq:cbs_semiimp_stabcond} получим
\begin{equation}
\nonumber
\tau_i < \min\left(\frac{h_i}{|\vec u|_i}, \frac{h_i^2 \Ren}{2}\right),
\end{equation}
где $h_i$ -- шаг сетки, ассоциированный с $i$-ым узлом сетки.



\subsubsection{Течения несжимаемой жидкости}
Постановка задачи \cref{eq:cbs_u,eq:cbs_v,eq:cbs_rho,eq:cbs_rho_p}
описывает течение несжимаемой жидкости в случае, если $c\to\infty$.
В этом случае полунеявная схема с условием устойчивости \cref{eq:cbs_semiimp_stabcond} остаётся применимой.
Явную схему в чистом виде применять нельзя из-за вырождения
левой части уравнения \cref{eq:cbs_preseq} при $\theta_2 = 0$.
\subsubsubsection{Искусственная сжимаемость}
Часто для расчёта течения стационарного несжимаемого течения
используют постановку с наличием слабой искусственной сжимаемости, характеризуемой параметром $\beta$
-- аналогом скорости распространения возмущений $c$ в \quo{сжимаемой} постановке.
Такая искуственная сжимаемоть способствут устойчивости расчётной схемы
(действительно, наличие $c>0$ увеличивает диагональные
значения матрицы левой части системы \cref{eq:cbs_preseq} и тем самым улучшает свойства этой матрицы).

В качестве параметра $\beta$ рекомендуется использовать соотношение
$$
\beta = \max\left(\beta^*, |\vec u|, \frac{1}{\Ren\, h}\right),
$$
где $\beta^*$ -- заданное минимальное значение искуственной сжимаемости.
По аналогии с $\tau$, в случае стационарных задач
параметр $\beta$ можно выбирать отдельно для каждого узла.

\subsubsubsection{Нестационарные задачи}
Для расчёта несжимаего течения
с использованием искуственной сжимаемости требуется, чтобы решение сошлось
по критерию
$$
\dfr{p}{t} \approx 0.
$$
То есть требуется решать задачу методом установления.
Если при этом задача является нестационарной, то задача
дискретизуется с
двойным временем: физическим временем с шагом $\triangle t$
для продвижения вперёд и 
фиктивным временем с шагом $\tau$ для сходимости
внутри временного слоя. Построение схем
таким методом подробно разбирался в п.~\ref{sec:ns2d-nonstat}.


\subsection{Задание для самостоятельной работы}
Тесты \ename{[cavern2-fem-im-cbs]}, \ename{[cavern2-fem-ex-cbs]}
из файла \ename{cavern_2d_fem_cbs_test.cpp}
реализует полунеявную (п.~\ref{seq:cbs_semiimp}, $\theta_1 = 1, \theta_2 = 1$) 
и чисто явную (п.~\ref{seq:cbs_exp}, $\theta_1 = 1, \theta_2 = 0$) CBS схемы
расчёта стационарной задачи
о течении несжимаемой жидкости в каверне.

В процессе вычисления идёт расчет (и печать в консоль) изменения искомых полей течения
по фиктивному времени. Эти изменеия характеризуются среднеквадратичными
отклонениями соответсвтующих производных
$$
\left|\dfr{u}{t}\right|_2, \left|\dfr{v}{t}\right|_2, \left|\dfr{p}{t}\right|_2.
$$
Как только все три поля перестают меняться (их производная по времени
становится меньше заданного \cvar{eps}), расчёт останавливается.
Задача решается на регулярной сетке $20\times20$.

Шаг по фиктивному времени $\tau$
вычисляется по соотношениям \cref{eq:cbs_exp_stabcond,eq:cbs_semiimp_stabcond},
помноженным на заданный коэффициент \cvar{tau_coef}.

Необходимо:
\begin{itemize}
\item
Для анализа сходимости численного решения необходимо
уменьшить \cvar{eps} до $10^{-6}$.
\item
Нарисовать полученные поля решения в динамике сходимости на подробной сетке. Использовать изолинии
для отрисовки давления и вектора для отрисовки скорости.
\item
В качестве дополнительного выводного интегрального параметра (наряду с нормами производных по времени)
необходимо по
найденным на слое значениям скорости \cvar{_u,_v}
расчитать кинетическую энергию $E$ (см. п.~\ref{seq:cbs_kinetic_e}).
\item
Нарисовать график сходимости выводимых производных по времени (с логарифмической осью ординат)
и энергии $E$ от индекса итерации. Использовать регулярную сетке $50\times50$ с различными шагами по времени \cvar{tau_coef}.
Сравнить чисто явную и полунеявную схему.
\item
Проделать аналогичный тест на неструктурированной сетке \cvar{tetragrid} с примерно тем же количеством ячеек.
\end{itemize}

\subsubsection{Вычисление кинетической энергии}
\label{seq:cbs_kinetic_e}
Вычисление кинетической энергии
осуществляется с использованием
разложения по конечно элементному базису
\begin{equation}
\nonumber
E = \feint{\frac{|\vec U|^2}{2}} = \frac12\sum_{i=0}^{N}|\vec U|^2_i \feint{\phi_i}.
\end{equation}
здесь $|\vec U|^2_i$ -- узловое значение квадрата импульса, которое находится в виде
$$
|\vec U|^2_i = U_i^2 + V_i^2.
$$
а интеграл от базисной функции в правой части -- есть вектор нагрузок.
Вычисление этого вектора должно осуществляться поэлементно:

\begin{cppcode}
// Инициализируем нулями вектор. Его длина соответствует кол-ву степеней свободы
std::vector<double> load_vector(n_bases, 0);
// Цикл по элементам
for (size_t ielem = 0; ielem < n_elements; ++ielem){
	// Текущий элемент
	auto elem = _fem.element(ielem);
	// Локальный вектор нагрузок. Его длина -- кол-во степеней свободы в элементе
	auto local_load_vector = elem.integrals->load_vector();
	// Добавить локальный вектор в глобальный.
	_fem.add_to_global_vector(ielem, local_load_vector, load_vector);
}
\end{cppcode}
Вектор нагрузок рекомендуется вычислять один раз на этапе инициализации.
